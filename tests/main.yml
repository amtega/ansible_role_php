---
# Tasks for testing role
- name: Configure sandbox environment
  hosts: localhost
  roles:
    - role: amtega.docker_presets
      docker_presets_images_json_query: >-
        [? starts_with(name, `centos-7`) ]
  tags:
    - sandbox

- name: Setup testing sandbox
  hosts: localhost
  roles:
    - role: amtega.docker_sandbox
      docker_sandbox_state: started
  tags:
    - sandbox

- name: Prepare some variables required by the tests
  hosts: docker_sandbox_containers
  tasks:
    - name: Setup some variables required by tests
      set_fact:
        php_modules_testhostvars:
          - name: php-pecl-redis
            state: present
  tags:
    - idempotence

- name: Test php role
  hosts: docker_sandbox_containers
  roles:
      - role: amtega.apache
        vars:
          apache_aditional_modules: []

      - role: amtega.php
        vars:
          php_ini_values:
            - variable: max_execution_time
              value: 60
              section: PHP
            - variable: memory_limit
              value: 256M
              section: PHP
            - variable: post_max_size
              value: 22M
              section: PHP
            - variable: upload_max_filesize
              value: 20M
              section: PHP
            - variable: date.timezone
              value: Europe/Madrid
              section: Date
  tasks:
    - meta: flush_handlers

    - name: Create a index.php with phpinfo
      copy:
        dest: "/var/www/html/index.php"
        content: |
          <?php
            phpinfo();
          ?>

    - name: Check that apache is listening
      wait_for:
        port: 80
        timeout: 10

    - name: Check that http port returns phpinfo page
      uri:
        url: "http://localhost/index.php"
        return_content: yes
      register: check_phpinfo_result

    - name: Ensure php.ini values are adjusts
      assert:
        that:
          - check_phpinfo_result.content is search('<tr><td class="e">upload_max_filesize</td><td class="v">20M</td><td class="v">20M</td></tr>')

    - name: Register php modules
      command: "/usr/bin/php -m"
      changed_when: false
      register: php_read_modules_installed

    - name: Ensure php modules are load
      assert:
        that:
          - php_read_modules_installed.stdout is search("Core")
          - php_read_modules_installed.stdout is search("fileinfo")
          - php_read_modules_installed.stdout is search("iconv")
          - php_read_modules_installed.stdout is search("mysqlnd")
          - php_read_modules_installed.stdout is search("Zend OPcache")
          - php_read_modules_installed.stdout is search("gd")
          - php_read_modules_installed.stdout is search("mbstring")
          - php_read_modules_installed.stdout is search("intl")
          - php_read_modules_installed.stdout is search("redis")

    - name: Register php version
      command: "/usr/bin/php -v"
      changed_when: false
      register: php_read_version_installed

    - name: Ensure php version is correct
      assert:
        that:
          - php_read_version_installed.stdout is search("PHP 7.4")

  tags:
    - idempotence

- name: Cleanup testing sandbox
  hosts: localhost
  roles:
    - role: amtega.docker_sandbox
      vars:
        docker_sandbox_state: absent
  tags:
    - sandbox
    - cleanup
